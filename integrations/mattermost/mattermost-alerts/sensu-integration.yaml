---
type: Integration
api_version: catalog/v1
metadata:
  namespace: mattermost
  name: mattermost-alerts
spec:
  class: supported
  provider: alerts
  display_name: Mattermost
  short_description: Send alerts to a Mattermost channel
  tags:
    - mattermost
    - alerts
  contributors:
    - "@sensu"
    - "@calebhailey"
    - "@jspaleta"
  prompts:
    - type: section
      title: Mattermost Configuration
    - type: markdown
      body: |
        Specify the Mattermost [webhook URL] and the [channel] that should receive alerts.

        [webhook URL]: https://docs.mattermost.com/developer/webhooks-incoming.html
        [channel]: https://docs.mattermost.com/guides/channels.html
    - type: question
      name: mattermost_webhook_url
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: Mattermost webhook URL
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the Mattermost webhook URL
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the Mattermost webhook URL
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: Mattermost webhook URL
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the Mattermost webhook URL as a backend environment variable
              env_var:
                type: string
                title: Mattermost webhook URL
                description: >-
                  Enter the Mattermost webhook URL (URL will be stored in the Sensu API as unencrypted plaintext)
    - type: question
      name: mattermost_channel
      required: true
      input:
        type: string
        title: Mattermost channel
        description: >-
          Enter the name of the Mattermost channel that should receive alerts
        default: "#alerts"
  resource_patches:
    - resource:
        api_version: core/v2
        type: Handler
        name: mattermost
      patches:
        - op: add
          path: /spec/env_vars/-
          value: "MATTERMOST_CHANNEL=[[mattermost_channel]]"
        - op: add
          path: /spec/env_vars/-
          value: "MATTERMOST_WEBHOOK_URL=[[mattermost_webhook_url.env_var]]"
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[mattermost_webhook_url.secret]]"
            name: MATTERMOST_WEBHOOK_URL
  post_install:
    - type: section
      title: Success
    - type: markdown
      body: |
        You enabled the Mattermost integration.

        Sensu will forward events from checks that reference the `mattermost` pipeline to `[[mattermost_channel]]`.

        Add the `mattermost` pipeline reference to one or more checks:

        ```yaml
        spec:
          pipelines:
            - api_version: core/v2
              type: Pipeline
              name: mattermost
        ```