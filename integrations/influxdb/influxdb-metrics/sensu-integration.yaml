---
api_version: catalog/v1
type: Integration
metadata:
  namespace: "influxdb"
  name: "influxdb-metrics"
spec:
  class: supported
  provider: metrics
  display_name: InfluxDB Metrics
  short_description: Send metrics to an InfluxDB database
  tags:
    - influxdb
    - metrics
  contributors:
    - "@sensu"
  prompts:
    - type: section
      title: InfluxDB Configuration
    - type: markdown
      body: |
        Specify the InfluxDB v2 server, organization name, bucket name, and API token.

        For InfluxDb v1.8+, substitute `""` for organization, `<DATABASE>/<RETENTION_POLICY>` for bucket, and `<USERNAME>:<PASSWORD>` for API token.
    - type: question
      name: influxdb_addr
      required: true
      input:
        type: string
        required: true
        title: InfluxDB v2 server URL
        description: >-
          Enter the InfluxDB v2 URL (e.g. http://influxdb.mycompany.com:8086)
        default: http://influxdb.mycompany.com:8086
    - type: question
      name: influxdb_org
      required: true
      input:
        type: string
        required: true
        title: InfluxDB v2 organization
        description: >-
          Enter the InfluxDB v2 organization name
        default: "sensu"
    - type: question
      name: influxdb_bucket
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: InfluxDB bucket
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the InfluxDB bucket name
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the InfluxDB bucket name
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: InfluxDB bucket
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the InfluxDB bucket name as a backend environment variable
              env_var:
                type: string
                title: InfluxDB Bucket
                description: >-
                  Enter the InfluxDB bucket name (bucket name will be stored in the Sensu API as unencrypted plaintext)
    - type: question
      name: influxdb_token
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: InfluxDB API token
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the InfluxDB API token
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the InfluxDB API token
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: InfluxDB API token
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the InfluxDB API token as a backend environment variable
              env_var:
                type: string
                title: InfluxDB API token
                description: >-
                  Enter the InfluxDB API token (token will be stored in the Sensu API as unencrypted plaintext)
  resource_patches:
    - resource:
        api_version: core/v2
        type: Handler
        name: influxdb
      patches:
        - op: add
          path: /spec/env_vars/-
          value: "INFLUXDB_ADDR=[[influxdb_addr]]"
        - op: add
          path: /spec/env_vars/-
          value: "INFLUXDB_ORG=[[influxdb_org]]"
        - op: add
          path: /spec/env_vars/-
          value: "INFLUXDB_BUCKET=[[influxdb_bucket.env_var]]"
        - op: add
          path: /spec/env_vars/-
          value: "INFLUXDB_TOKEN=[[influxdb_token.env_var]]"
        - op: add
          path: /spec/secrets/-
          value:
            name: INFLUXDB_TOKEN
            secret: "[[influxdb_token.secret]]"
        - op: add
          path: /spec/secrets/-
          value:
            name: INFLUXDB_BUCKET
            secret: "[[influxdb_bucket.secret]]"
  post_install:
    - type: section
      title: Success
    - type: markdown
      body: |
        You enabled the InfluxDB Metrics integration.

        Sensu will forward events from checks that reference the `influxdb-metrics` pipeline to `[[influxdb_addr]]`.

        Add the `influxdb-metrics` pipeline reference to one or more checks:

        ```yaml
        spec:
          pipelines:
            - api_version: core/v2
              type: Pipeline
              name: influxdb-metrics
        ```