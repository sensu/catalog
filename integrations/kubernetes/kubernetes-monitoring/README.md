## Overview

<!-- Sensu Integration description; supports markdown -->

The Kubernetes Monitoring integraton sends liveness alerts and collects metrics from Kubernetes system components.

<!-- Provide a high level overview of the integration contents (e.g. checks, filters, mutators, handlers, assets, etc) -->

This integration provides the following Sensu resources:

* `kubernetes-liveness` [check]
* `kubelet-metrics` [check]
* `kubelet-probe-metrics` [check]
* `kubelet-cadvisor-metrics` [check]
* `sensu/http-checks` [asset]

## Dashboards

<!-- List of supported dashboards w/ screenshots (supports png, jpeg, and gif images; relative paths only; e.g. `![](img/dashboard-1.png)` )-->

The Kubernetes Monitoring integration does not have compatible dashboards.

## Setup

<!-- Sensu Integration setup instructions, including Sensu agent configuration and external component configuration -->
<!-- EXAMPLE: what configuration (if any) is required in a third-party service to enable monitoring? -->

1. Get the [kube-apiserver] URL and Kubelet API URL.

1. Decide which Sensu agents should execute the checks this integration creates. You will need the agent [subscription] names when you install this integration.

1. If you want to use a Sensu [pipeline] to process Kubernetes Monitoring integration data, you will need the pipeline names when you install this integration.

   You can configure separate pipelines for alerts, metrics, and incident management.

1. Confirm that at least one Sensu agent has access to the Kubernetes API server (kube-apiserver).

   By default, a `sensu-agent` that runs in a Kubernetes pod has access to the Kubernetes API server via the `kubernetes.default.svc` DNS record.

1. Confirm that there is only one Sensu agent per Kubelet host.

   A `sensu-agent` that runs directly on the Kubelet host *or* in a [Kubernetes DaemonSet] with `hostNetwork: true` and `dnsPolicy: ClusterFirstWithHostNet` has access to the Kubelet API via `localhost` or `127.0.0.1`.

   The Kubernetes Monitoring integration is designed to work with the default [Kubernetes service account] credentials that are available if run from a Sensu agent sidecar or DaemonSet (i.e. from a Kubernetes Pod).

   <details><summary><strong>Example: Kubernetes DaemonSet manifest</strong></summary>

   ```yaml
   ---
   kind: DaemonSet
   apiVersion: apps/v1
   metadata:
     name: sensu-agent
   spec:
     minReadySeconds: 10
     updateStrategy:
       type: RollingUpdate
       rollingUpdate:
         maxUnavailable: 1
     selector:
       matchLabels:
         app: sensu-agent
     template:
       metadata:
         labels:
           app: sensu-agent
       spec:
         tolerations: []
         terminationGracePeriodSeconds: 30
         hostPID: true
         hostIPC: true
         hostNetwork: true
         dnsPolicy: ClusterFirstWithHostNet
         volumes: []
         containers:
         - name: sensu-agent
           image: sensu/sensu:6.6.3
           command: [
             "/opt/sensu/bin/sensu-agent", "start",
             "--detect-cloud-provider", "true",
             "--log-level", "warn",
           ]
           env:
           - name: KUBELET_HOST
             valueFrom:
               fieldRef:
                 fieldPath: status.hostIP
           - name: KUBE_NAMESPACE
             valueFrom:
               fieldRef:
                 fieldPath: metadata.namespace
           - name: SENSU_BACKEND_URL
             value: "wss://sensu.yourcompany.com:8081"
           - name: SENSU_NAMESPACE
             value: "sensu-system"
           - name: SENSU_SUBSCRIPTIONS
             value: "kubernetes kubernetes/api kubernetes/daemonset"
           - name: SENSU_KEEPALIVE_INTERVAL
             value: "30"
           - name: SENSU_KEEPALIVE_WARNING_TIMEOUT
             value: "120"
           - name: SENSU_DEREGISTER
             value: "true"
           ports: []
           resources:
             limits:
               cpu: 1.0
               memory: 1024M
             requests:
               cpu: 0.25
               memory: 256M
   ```

   </details>
   <br>

## Plugins

<!-- Links to any Sensu Integration dependencies (i.e. Sensu Plugins) -->

The Kubernetes Monitoring integration uses the following Sensu [plugins]:

- [sensu/http-checks][http-checks-bonsai] ([GitHub][http-checks-github])

## Alerts

<!-- List of all alerts generated by this integration. -->

**`/livez` health**

Generates a WARNING event when the [Kubernetes `/livez` API][kubernetes-health-apis] returns an HTTP 4xx response code.

## Metrics

<!-- List of all metrics or events collected by this integration. -->

The Kubernetes Monitoring integration collects various metrics from Kubernetes system components, including `kube-apiserver` and `kubelet` metrics. Read [Metrics for Kubernetes System Components] for more information.

## Reference Documentation

<!-- Please provide links to any relevant reference documentation to help users learn more and/or troubleshoot this integration. -->

* [Kubernetes API health endpoints] (Kubernetes documentation)

   <details><summary><strong>Curl and wget command equivalents</strong></summary>

   The `curl` command equivalent of the Kubernetes Monitoring integration, if run from a Kubernetes pod, is:

   ```shell
   curl -s && \
   --header "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" && \
   --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt && \
   https://kubernetes.default.svc:${KUBERNETES_SERVICE_PORT:-443}/livez?verbose
   ```

   The `wget` command equivalent of the Kubernetes Monitoring integration, if run from a Kubernetes pod, is:

   ```shell
   wget -q -O- && \
   --header "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" && \
   --ca-certificate /var/run/secrets/kubernetes.io/serviceaccount/ca.crt && \
   https://kubernetes.default.svc:${KUBERNETES_SERVICE_PORT:-443}/livez?verbose
   ```

   </details>
   <br>

* Accessing the Kubernetes API from a Pod: [Directly accessing the REST API] (Kubernetes documentation)
* [Configure Service Accounts for Pods][Kubernetes service account] (Kubernetes documentation)
* Service: [Environment variables] (Kubernetes documentation)

   <details><summary><strong>Built-in pod environment variables</strong></summary>

   The built-in pod environment variable `KUBERNETES_SERVICE_HOST` is also mapped to the `kubernetes.default.svc` hostname.
  
   The built-in pod environment variable `KUBERNETES_SERVICE_PORT` is also available in case the port is not set to the default (`443`).

   </details>
   <br>


<!-- Links -->
[check]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/checks/
[asset]: https://docs.sensu.io/sensu-go/latest/plugins/assets/
[subscription]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/subscriptions/
[agents]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/agent/
[annotation]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/agent/#general-configuration-flags
[plugins]: https://docs.sensu.io/sensu-go/latest/plugins/
[metrics]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/metrics/
[handler]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-process/handlers/
[http-checks-bonsai]: https://bonsai.sensu.io/assets/sensu/http-checks
[http-checks-github]: https://github.com/sensu/http-checks
[kubernetes-health-apis]: https://kubernetes.io/docs/reference/using-api/health-checks/
[Kubernetes service account]: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/
[Metrics for Kubernetes System Components]: https://kubernetes.io/docs/concepts/cluster-administration/system-metrics/
[kube-apiserver]: https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/
[Kubernetes DaemonSet]: https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/
[Kubernetes API health endpoints]: https://kubernetes.io/docs/reference/using-api/health-checks/
[Directly accessing the REST API]: https://kubernetes.io/docs/tasks/run-application/access-api-from-pod/#directly-accessing-the-rest-api
[Environment variables]: https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables
[pipeline]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-process/pipelines/
