---
api_version: catalog/v1
type: Integration
metadata:
  namespace: pushover
  name: pushover-alerts
spec:
  class: supported
  provider: alerts
  display_name: Pushover Alerts
  short_description: Send alerts as Pushover notifications
  supported_platforms:
    - linux
  tags:
    - pushover
    - incidents
    - alerts
  contributors:
    - "@sensu"
    - "@nixwiz"
    - "@jspaleta"
    - "@calebhailey"
  prompts:
    - type: section
      title: Pushover Configuration
    - type: markdown
      body: |
        Specify the Pushover user identifier and application API token.
    - type: question
      name: pushover_user_key
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: Pushover user identifier
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the Pushover user identifier
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the Pushover user identifier
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: Pushover user identifier
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the Pushover user identifier as a backend environment variable
              env_var:
                type: string
                title: Pushover user identifier
                description: >-
                  Enter the Pushover user identifier (identifier will be stored in the Sensu API as unencrypted plaintext)
    - type: question
      name: pushover_app_api_token
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: Pushover Application API Token
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the Pushover application API token
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the Pushover application API token
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: Pushover application API token
                const: env_var
                constLocale:
                  title: Environment Variable
                  description: >-
                    Save the Pushover application API token as a backend environment variable
              env_var:
                type: string
                title: Pushover Application API Token
                description: >-
                  Enter the Pushover application API token (token name will be stored in the Sensu API as unencrypted plaintext)
  resource_patches:
    - resource:
        api_version: core/v2
        type: Handler
        name: pushover-alerts
      patches:
        - op: add
          path: /spec/env_vars/-
          value: "SENSU_PUSHOVER_USERKEY=[[pushover_user_key.env_var]]"
        - op: add
          path: /spec/env_vars/-
          value: "SENSU_PUSHOVER_TOKEN=[[pushover_app_api_token.env_var]]"
        - op: add
          path: /spec/secrets/-
          value:
            name: SENSU_PUSHOVER_USERKEY
            secret: "[[pushover_user_key.secret]]"
        - op: add
          path: /spec/secrets/-
          value:
            name: SENSU_PUSHOVER_TOKEN
            secret: "[[pushover_app_api_token.secret]]"
  post_install:
    - type: section
      title: Success
    - type: markdown
      body: |
        You enabled the Pushover Alerts integration.

        Sensu will forward events from checks that reference the `pushover-metrics` pipeline to the specified user.

        Add the `pushover-metrics` pipeline reference to one or more checks:

        ```yaml
        spec:
          pipelines:
            - api_version: core/v2
              type: Pipeline
              name: pushover-metrics
        ```