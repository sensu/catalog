---
api_version: catalog/v1
type: Integration
metadata:
  namespace: "servicenow"
  name: "servicenow-incidents"
spec:
  class: enterprise
  provider: incidents
  display_name: ServiceNow Incident Management
  short_description: Create, update, and resolve ServiceNow incidents based on Sensu events
  supported_platforms:
    - darwin
    - linux
    - windows
  tags:
    - servicenow
    - incidents
  contributors:
    - "@sensu"
    - "@calebhailey"
  prompts:
    - type: section
      title: ServiceNow Instance Configuration
    - type: markdown
      body: |
        Specify the ServiceNow instance URL, username, and password.
    - type: question
      name: servicenow_url
      required: true
      input:
        type: string
        format: url
        title: ServiceNow instance base URL
        description:
          Enter the ServiceNow intance base URL
        default: https://mycompany.service-now.com
    - type: question
      name: servicenow_username
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: ServiceNow username
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the ServiceNow username
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the ServiceNow username
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: ServiceNow username
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the ServiceNow username as a backend environment variable
              env_var:
                type: string
                title: ServiceNow username
                description: >-
                  Enter the ServiceNow username (username will be stored in the Sensu API as unencrypted plaintext)
    - type: question
      name: servicenow_password
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: ServiceNow password
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the ServiceNow password
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the ServiceNow password
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: ServiceNow password
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the ServiceNow password as a backend environment variable
              env_var:
                type: string
                title: ServiceNow password
                description: >-
                  Enter the ServiceNow password (password will be stored in the Sensu API as unencrypted plaintext)
    - type: section
      title: ServiceNow Customizations
    - type: markdown
      body: |
        If your organization has a customized ServiceNow instance, provide the following configuration information to customize this integration:

        * Name of the ServiceNow incident table to use for managing incidents
        * Incident key: the field name that Sensu should use to look up incidents
        * [Handler templates] for incidents' short descriptions and work notes
        * Custom incident properties to populate from Sensu entity annotations

        If you do not have a customized ServiceNow instance, the default values will work with unmodified ServiceNow instances.

        [handler template]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-process/handler-templates/
    - type: question
      name: servicenow_incident_table
      required: true
      input:
        type: string
        title: Incident table
        description: >-
          Enter the name of the ServiceNow table to use for managing incidents
        default: incident
    - type: question
      name: servicenow_incident_key
      required: true
      input:
        type: string
        title: Incident key
        description: >-
          Enter the incident key (the field name Sensu should use to look up incidents)
        default: short_description
    - type: question
      name: servicenow_incident_name
      required: true
      input:
        type: string
        title: Incident short description template
        description: >-
          Enter the handler template to use to generate short descriptions for incidents
        default: "{{ .Entity.State }}"
    - type: question
      name: servicenow_incident_work_notes
      required: true
      input:
        type: string
        title: Incident work notes template
        description: >-
          Enter the handler template to use to generate work notes for incidents
        default: "{{ .Check.Output }}"
    - type: question
      name: servicenow_incident_properties
      required: true
      input:
        type: string
        title: Custom incident properties
        description: >-
          Enter a comma-separated list of custom incident properties to populate from Sensu entity annotations
        default: category
  resource_patches:
    - resource:
        api_version: core/v2
        type: Handler
        name: servicenow-incidents
      patches:
        - op: replace
          path: /spec/command
          value: >-
            sensu-servicenow-handler
            --incident-management
            --incident-table [[servicenow_incident_table]]
            --incident-key [[servicenow_incident_key]]
            --incident-description "[[servicenow_incident_description]]"
            --incident-work-notes "[[servicenow_incident_work_notes]]"
            --incident-properties "[[servicenow_incident_properties]]"
        - op: add
          path: /spec/env_vars/-
          value: "SERVICENOW_URL=[[servicenow_url]]"
        - op: add
          path: /spec/env_vars/-
          value: "SERVICENOW_USERNAME=[[servicenow_username.env_var]]"
        - op: add
          path: /spec/env_vars/-
          value: "SERVICENOW_PASSWORD=[[servicenow_password.env_var]]"
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[servicenow_username.secret]]"
            name: SERVICENOW_USERNAME
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[servicenow_password.secret]]"
            name: SERVICENOW_PASSWORD
  post_install:
    - type: section
      title: Success
    - type: markdown
      body: |
        You enabled the ServiceNow Incident Management integration.

        To enable ServiceNow incident management, add the `servicenow-incident` pipeline to a check definition:

        ```yaml
        spec:
          pipelines:
            - api_version: core/v2
              type: Pipeline
              name: servicenow-incident
        ```