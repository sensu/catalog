---
api_version: catalog/v1
type: Integration
metadata:
  namespace: jira
  name: jira-servicedesk-incidents
spec:
  class: enterprise
  provider: incidents
  display_name: Jira Service Management
  short_description: Create & resolve incidents in Jira Service Management
  tags:
    - jira
    - servicedesk
    - incidents
    - alerts
  contributors:
    - "@sensu"
  prompts:
    - type: section
      title: Jira Service Management Configuration
    - type: markdown
      body: |
        Provide these Jira Service Management configuration parameters:

        * Jira base URL (e.g. `https://mycompany.atlassian.net`)
        * Jira Service Management project key (e.g. `OPS`)
        * Jira Service Management issue type (e.g. `[System] Incident`)
    - type: question
      name: jira_url
      required: true
      input:
        type: string
        title: Jira base URL
        description: Enter the Jira site base URL
        default: "https://mycompany.atlassian.net"
    - type: question
      name: jira_project_key
      required: true
      input:
        type: string
        title: Jira project key
        description: Enter the Jira Service Management project key
        default: "OPS"
    - type: question
      name: jira_issue_type
      required: true
      input:
        type: string
        title: Jira issue type
        description: Enter the Jira Service Management issue type
        default: "[System] Incident"
    - type: section
      title: Jira Service Management Authentication
    - type: markdown
      body: |
        Provide the Jira Service Management username and [API token].

        [API token]: https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account/
    - type: question
      name: jira_username
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: Jira username
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the Jira username
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the Jira username
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: Jira username
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the Jira username as a backend environment variable
              env_var:
                type: string
                title: Jira username
                description: >-
                  Enter the Jira username (username will be stored in the Sensu API as unencrypted plaintext)
    - type: question
      name: jira_api_token
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: Jira API token
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the Jira API token
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the Jira API token
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: Jira API token
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the Jira API token as a backend environment variable
              env_var:
                type: string
                title: Jira API token
                description: >-
                  Enter the Jira API token (token will be stored in the Sensu API as unencrypted plaintext)
  resource_patches:
    - resource:
        api_version: core/v2
        type: Handler
        name: jira-servicedesk-handler
      patches:
        - op: add
          path: /spec/env_vars/-
          value: JIRA_URL=[[jira_url]]
        - op: add
          path: /spec/env_vars/-
          value: JIRA_PROJECT_KEY=[[jira_project_key]]
        - op: add
          path: /spec/env_vars/-
          value: JIRA_ISSUE_TYPE=[[jira_issue_type]]
        - op: add
          path: /spec/env_vars/-
          value: JIRA_USERNAME=[[jira_username.env_var]]
        - op: add
          path: /spec/env_vars/-
          value: JIRA_PASSWORD=[[jira_api_token.env_var]]
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[jira_username.secret]]"
            name: JIRA_USERNAME
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[jira_api_token.secret]]"
            name: JIRA_PASSWORD
  post_install:
    - type: section
      title: Success
    - type: markdown
      body: |
        You enabled the Jira Service Management integration.

        For events from checks that reference the `jira-servicedesk-incidents` pipeline, Sensu will create incidents in `[[jira_url]]` with project key [[jira_project_key]] and issue type [[jira_issue_type]].

        Add the `jira-servicedesk-incidents` pipeline reference to one or more checks:

        ```yaml
        spec:
          pipelines:
            - api_version: core/v2
              type: Pipeline
              name: jira-servicedesk-incidents
        ```