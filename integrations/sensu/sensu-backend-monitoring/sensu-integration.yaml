---
api_version: catalog/v1
type: Integration
metadata:
  namespace: sensu
  name: sensu-backend-monitoring
spec:
  class: supported # community, supported, enterprise, or partner
  provider: monitoring
  display_name: Sensu Backend Monitoring
  short_description: Check Sensu backend health
  supported_platforms:
    - darwin
    - linux
    - windows
  tags:
    - sensu
    - postgres
    - postgresql
    - pgsql
    - database
  contributors:
    - "@sensu"
    - "@asachs01"
  prompts:
    - type: section
      title: Sensu Backend Health Monitoring Configuration
    - type: markdown
      body: |
        Specify the Sensu [backend API URL] and the interval for executing the `sensu-backend-postgresql-health` check (in seconds).

        [backend API URL]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/backend/#backend-api-url-attribute
    - type: question
      name: url
      required: false
      input:
        type: string
        title: Sensu Backend URL
        description: >-
          Enter the complete URL for your Sensu backend, including the `/health` endpoint
        format: url
        default: http://127.0.0.1:8080/health
    - type: question
      name: interval
      required: false
      input:
        type: integer
        title: Interval
        description: >-
          Specify the check interval, in seconds (60 = 1 minute, 300 = 5 minutes, 600 = 10 minutes)
        default: 30
    - type: section
      title: Subscriptions
    - type: markdown
      body: |
        Specify the subscriptions for Sensu agents that should execute the `sensu-backend-postgresql-health` check
    - type: question
      name: subscriptions
      input:
        type: array
        items:
          type: string
          title: Sensu Subscriptions
          ref: core/v2/entity/subscriptions
        default:
          - sensu-backend
    - type: section
      title: Pipeline Configuration
    - type: markdown
      body: |
        Name the [pipelines] you want to use to process Sensu Backend Monitoring integration data.

        [pipelines]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-process/pipelines/
    - type: question
      name: alert_pipeline
      required: false
      input:
        type: string
        title: Alert pipeline name
        description: >-
          Which pipeline do you want to use for alerts due to failures this integration detects?
        ref: core/v2/pipeline/metadata/name
        refFilter: .labels.provider == "alerts"
    - type: question
      name: incident_pipeline
      required: false
      input:
        type: string
        title: Incident pipeline name
        description: >-
          Which pipeline do you want to use to process incidents due to failures this integration detects?
        ref: core/v2/pipeline/metadata/name
        refFilter: .labels.provider == "incidents"
  resource_patches:
    - resource:
        api_version: core/v2
        type: CheckConfig
        name: sensu-backend-postgresql-health
      patches:
        - op: replace
          path: /spec/interval
          value: interval
        - op: replace
          path: /spec/command
          value: >-
            http-json
            --url {{ .annotations.sensu_backend_health_url | default "[[url]]"}}
            --query ".PostgresHealth.[0].Healthy"
            --expression "== true"
        - op: add
          path: /spec/pipelines/-
          value:
            api_version: "core/v2"
            type: "Pipeline"
            name: "[[alert_pipeline]]"
        - op: add
          path: /spec/pipelines/-
          value:
            api_version: "core/v2"
            type: "Pipeline"
            name: "[[incident_pipeline]]"
        - op: replace
          path: /spec/subscriptions
          value: subscriptions
  post_install:
    - type: section
      title: Success
    - type: markdown
      body: |
        You enabled the Sensu Backend Monitoring integration.

        The `sensu-backend-postgresql-health` check will run for the Sensu backend with API URL [[ url ]].