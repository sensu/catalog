---
api_version: catalog/v1
type: Integration
metadata:
  namespace: aws
  name: aws-sns-events
spec:
  class: supported
  provider: events
  display_name: AWS SNS Events
  short_description: Publish Sensu events as Amazon SNS messages
  supported_platforms:
    - darwin
    - linux
    - windows
  tags:
    - aws
  contributors:
    - "@sensu"
  prompts:
    - type: section
      title: AWS Configuration
    - type: markdown
      body: |
        Provide these AWS configuration parameters:

        * AWS region
        * Amazon resource name (ARN) for the Amazon SNS topic
        * AWS access key ID + AWS secret access key
    - type: question
      name: aws_region
      required: true
      input:
        type: string
        title: AWS region
        description: >-
          Select an AWS region
        enum:
          - us-east-1
          - us-east-2
          - us-west-1
          - us-west-2
          - af-south-1
          - ap-east-1
          - ap-southeast-3
          - ap-south-1
          - ap-northeast-3
          - ap-northeast-2
          - ap-southeast-1
          - ap-southeast-2
          - ap-northeast-1
          - ca-central-1
          - eu-central-1
          - eu-west-1
          - eu-west-2
          - eu-south-1
          - eu-west-3
          - eu-north-1
          - me-south-1
          - sa-east-1
          - us-gov-east-1
          - us-gov-west-1
        default: us-east-1
    - type: question
      name: sns_topic_arn
      required: true
      input:
        type: string
        title: Amazon SNS topic ARN
        description: Enter the ARN for the Amazon SNS topic
    - type: question
      name: aws_access_key_id
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: AWS access key ID
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the AWS access key ID
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the AWS access key ID
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: AWS access key ID
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the AWS access key ID as a backend environment variable
              env_var:
                type: string
                title: AWS access key ID
                description: >-
                  Enter the AWS access key ID (ID will be stored in the Sensu API as unencrypted plaintext)
    - type: question
      name: aws_secret_access_key
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: AWS secret access key
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the AWS secret access key
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the AWS secret access key
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: AWS secret access key
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the AWS secret access key as a backend environment variable
              env_var:
                type: string
                title: AWS secret access key
                description: >-
                  Enter the AWS secret access key (key will be stored in the Sensu API as unencrypted plaintext)
  resource_patches:
    - resource:
        api_version: core/v2
        type: Handler
        name: aws-sns-events
      patches:
        - op: add
          path: /spec/env_vars/-
          value: "AWS_REGION=[[aws_region]]"
        - op: add
          path: /spec/env_vars/-
          value: "SNS_TOPIC_ARN=[[sns_topic_arn]]"
        - op: add
          path: /spec/env_vars/-
          value: "AWS_ACCESS_KEY_ID=[[aws_access_key_id.env_var]]"
        - op: add
          path: /spec/env_vars/-
          value: "AWS_SECRET_ACCESS_KEY=[[aws_secret_access_key.env_var]]"
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[aws_access_key_id.secret]]"
            value: AWS_ACCESS_KEY_ID
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[aws_secret_access_key.secret]]"
            value: AWS_SECRET_ACCESS_KEY
  post_install:
    - type: section
      title: Success
    - type: markdown
      body: |
        You enabled the AWS SNS Events integration.

        Sensu will forward events from checks that reference the `aws-sns-events` pipeline to the `[[sns_topic_arn]]` Amazon SNS topic ARN.

        Add the `aws-sns-events` pipeline reference to one or more checks:

        ```yaml
        spec:
          pipelines:
            - api_version: core/v2
              type: Pipeline
              name: aws-sns-events
        ```