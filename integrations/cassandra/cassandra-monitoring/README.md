## Overview

The Cassandra Monitoring integration uses [Apache Cassandra's][Apache Cassandra documentation] [nodetool] to alert for nodes that are unreachable or have a schema disagreement and collect [`tpstats`][`nodetool tpstats` command] metrics in Graphite format.

This integration includes the following Sensu resources:

* `cassandra-healthcheck` [check]
* `cassandra-metrics` [check]
* `sensu-plugins/sensu-plugins-cassandra:3.0.2` [asset]
* `sensu/sensu-ruby-runtime:0.0.10` [asset]

## Dashboards

<!-- List of compatible dashboards w/ screenshots (supports png, jpeg, and gif images; relative paths only; e.g. `![](img/dashboard-1.png)` )-->

<!-- This integration is compatible with the [{{dashboard_name}}][{{dashboard_link}}] (included w/ [Sensu Plus][sensu-plus]). -->

<!-- ![](img/dashboard.png) -->

The Cassandra Monitoring integration does not have compatible dashboards.

## Setup

1. Decide which Sensu agents should execute the `cassandra-healthcheck` and `cassandra-metrics` checks. You will need the agent [subscription] names when you install this integration.

1. If you want to use a Sensu [pipeline] to process Cassandra Monitoring integration data, you will need the pipeline names when you install this integration.

   You can configure separate pipelines for alerts, metrics, and incident management.

1. **Optional** Specify a custom hostname and port.

   The Cassandra Monitoring integration uses default parameters for Cassandra hostname (`localhost`) and port (`7199`).

   To override the default parameters and specify custom parameters, add the `cassandra_hostname` and `cassandra_port` [annotations] to the Sensu [agent] configuration file (`agent.yml`).

   <details><summary><strong>Example: Custom hostname and port configuration</strong></summary>

   ```yaml
   annotations:
     cassandra_hostname: "CUSTOM_HOSTNAME"
     cassandra_port: 9999
   ```

   </details>
   <br>

1. **Optional** Add the cfstats and filter options to the `cassandra-metrics` check command.

   The Cassandra Monitoring integration can collect detailed metrics on keyspaces and column families with [cfstats].

   To add the cfstats option, install this integration. Then, update the `cassandra-metrics` check to add the `--cfstats` flag in the check's `command` attribute.

   To output only metrics for column-families that match a specific regular expression, add the `--filter` flag with a regular expression argument in the check's `command` attribute.

   <details><summary><strong>Example: Check command with cfstats and filter options</strong></summary>

   ```yaml
   spec:
     command: >-
     metrics-cassandra-graphite.rb -h {{ .annotations.cassandra_hostname | default "localhost" }} -P {{ .annotations.cassandra_port | default 7199 }}
     --cfstats
     --filter <REGULAR_EXPRESSION>
   ```

   </details>
   <br>

## Plugins

<!-- Links to any Sensu Integration dependencies (i.e. Sensu Plugins) -->

The Cassandra Monitoring integration uses the following Sensu [plugins]:

* [sensu/sensu-plugins-cassandra][sensu-plugins-cassandra-bonsai] ([GitHub][sensu-plugins-cassandra-github])
* [sensu/sensu-ruby-runtime][sensu-ruby-runtime-bonsai] ([GitHub][sensu-ruby-runtime-github])

## Alerts

<!-- List of all alerts generated by this integration. -->

The Cassandra Monitoring integration produces the following events that will processed by the specified alerts pipeline:

**cassandra-healthcheck**

Generates a CRITICAL event when a node is unreachable or has a schema disagreement.

## Metrics

<!-- List of all metrics or events collected by this integration. -->

The Cassandra Monitoring integration collects many [metrics] in [Graphite format][graphite-format] and emits them to the specified metrics pipeline.

**Information Metrics**:

* `host.cassandra.exceptions`
* `host.cassandra.load`
* `host.cassandra.uptime`
* `host.cassandra.heap.used`
* `host.cassandra.heap.total`
* `host.cassandra.key_cache.capacity`
* `host.cassandra.key_cache.size`
* `host.cassandra.key_cache.hits`
* `host.cassandra.key_cache.requests`
* `host.cassandra.key_cache.hit_rate`
* `host.cassandra.row_cache.size`
* `host.cassandra.row_cache.capacity`
* `host.cassandra.row_cache.hits`
* `host.cassandra.row_cache.requests`
* `host.cassandra.row_cache.hit_rate`

**Thread Pool Metrics**:

* `host.cassandra.threadpool.ReadStage.active`
* `host.cassandra.threadpool.ReadStage.pending`
* `host.cassandra.threadpool.ReadStage.completed`
* `host.cassandra.threadpool.ReadStage.blocked`
* `host.cassandra.threadpool.RequestResponseStage.active`
* `host.cassandra.threadpool.RequestResponseStage.pending`
* `host.cassandra.threadpool.RequestResponseStage.completed`
* `host.cassandra.threadpool.RequestResponseStage.blocked`
* `host.cassandra.threadpool.MutationStage.active`
* `host.cassandra.threadpool.MutationStage.pending`
* `host.cassandra.threadpool.MutationStage.completed`
* `host.cassandra.threadpool.MutationStage.blocked`
* `host.cassandra.threadpool.ReadRepairStage.active`
* `host.cassandra.threadpool.ReadRepairStage.pending`
* `host.cassandra.threadpool.ReadRepairStage.completed`
* `host.cassandra.threadpool.ReadRepairStage.blocked`
* `host.cassandra.threadpool.ReplicateOnWriteStage.active`
* `host.cassandra.threadpool.ReplicateOnWriteStage.pending`
* `host.cassandra.threadpool.ReplicateOnWriteStage.completed`
* `host.cassandra.threadpool.ReplicateOnWriteStage.blocked`
* `host.cassandra.threadpool.GossipStage.active`
* `host.cassandra.threadpool.GossipStage.pending`
* `host.cassandra.threadpool.GossipStage.completed`
* `host.cassandra.threadpool.GossipStage.blocked`
* `host.cassandra.threadpool.AntiEntropyStage.active`
* `host.cassandra.threadpool.AntiEntropyStage.pending`
* `host.cassandra.threadpool.AntiEntropyStage.completed`
* `host.cassandra.threadpool.AntiEntropyStage.blocked`
* `host.cassandra.threadpool.MigrationStage.active`
* `host.cassandra.threadpool.MigrationStage.pending`
* `host.cassandra.threadpool.MigrationStage.completed`
* `host.cassandra.threadpool.MigrationStage.blocked`
* `host.cassandra.threadpool.MemtablePostFlusher.active`
* `host.cassandra.threadpool.MemtablePostFlusher.pending`
* `host.cassandra.threadpool.MemtablePostFlusher.completed`
* `host.cassandra.threadpool.MemtablePostFlusher.blocked`
* `host.cassandra.threadpool.StreamStage.active`
* `host.cassandra.threadpool.StreamStage.pending`
* `host.cassandra.threadpool.StreamStage.completed`
* `host.cassandra.threadpool.StreamStage.blocked`
* `host.cassandra.threadpool.FlushWriter.active`
* `host.cassandra.threadpool.FlushWriter.pending`
* `host.cassandra.threadpool.FlushWriter.completed`
* `host.cassandra.threadpool.FlushWriter.blocked`
* `host.cassandra.threadpool.MiscStage.active`
* `host.cassandra.threadpool.MiscStage.pending`
* `host.cassandra.threadpool.MiscStage.completed`
* `host.cassandra.threadpool.MiscStage.blocked`
* `host.cassandra.threadpool.InternalResponseStage.active`
* `host.cassandra.threadpool.InternalResponseStage.pending`
* `host.cassandra.threadpool.InternalResponseStage.completed`
* `host.cassandra.threadpool.InternalResponseStage.blocked`
* `host.cassandra.threadpool.HintedHandoff.active`
* `host.cassandra.threadpool.HintedHandoff.pending`
* `host.cassandra.threadpool.HintedHandoff.completed`
* `host.cassandra.threadpool.HintedHandoff.blocked`
* `host.cassandra.message_type.RANGE_SLICE.dropped`
* `host.cassandra.message_type.READ_REPAIR.dropped`
* `host.cassandra.message_type.BINARY.dropped`
* `host.cassandra.message_type.READ.dropped`
* `host.cassandra.message_type.MUTATION.dropped`
* `host.cassandra.message_type.REQUEST_RESPONSE.dropped`

## Reference Documentation

* [Token substitution] (Sensu documentation): the Cassandra Monitoring integration supports Sensu tokens for variable substitution with data from Sensu entities
* [sensu/sensu-plugins-cassandra][sensu/sensu-plugins-cassandra plugin documentation] (GitHub-hosted file): read for more information about check configuration options
* [Apache Cassandra documentation]
* [Nodetool][nodetool] (Apache Cassandra documentation)
* [`nodetool info` command] (Apache Cassandra documentation)
* [`nodetool tpstats` command] (Apache Cassandra documentation)
* [`nodetool cfstats` command] (DataStax documentation)


<!-- Links -->
[check]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/checks/
[asset]: https://docs.sensu.io/sensu-go/latest/plugins/assets/
[subscription]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/subscriptions/
[subscriptions]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/subscriptions/
[agent]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/agent/
[annotations]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/agent/#agent-annotations
[plugins]: https://docs.sensu.io/sensu-go/latest/plugins/
[metrics]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/metrics/
[handler]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-process/handlers/
[pipeline]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-process/pipelines/
[Token substitution]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/tokens/
[sensu-plus]: https://sensu.io/features/analytics
[sensu-plugins-cassandra-bonsai]: https://bonsai.sensu.io/assets/sensu-plugins/sensu-plugins-cassandra
[sensu-plugins-cassandra-github]: https://github.com/sensu-plugins/sensu-plugins-cassandra
[sensu-ruby-runtime-bonsai]: https://bonsai.sensu.io/assets/sensu/sensu-ruby-runtime
[sensu-ruby-runtime-github]: https://github.com/sensu/sensu-ruby-runtime
[graphite-format]: https://graphite.readthedocs.io/en/latest/feeding-carbon.html#the-plaintext-protocol
[Apache Cassandra documentation]: https://cassandra.apache.org/doc/latest/
[nodetool]: https://cassandra.apache.org/doc/latest/cassandra/tools/nodetool/nodetool.html
[sensu/sensu-plugins-cassandra plugin documentation]: https://github.com/sensu-plugins/sensu-plugins-cassandra/blob/master/bin/metrics-cassandra-graphite.rb
[`nodetool info` command]: https://cassandra.apache.org/doc/latest/cassandra/tools/nodetool/info.html
[`nodetool tpstats` command]: https://cassandra.apache.org/doc/latest/cassandra/tools/nodetool/tpstats.html
[`nodetool cfstats` command]: https://docs.datastax.com/en/cassandra-oss/2.1/cassandra/tools/toolsCFstats.html
